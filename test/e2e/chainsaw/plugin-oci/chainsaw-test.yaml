# Test: Plugin with OCI artifact reference.
# Verifies the artifact-operator pulls a plugin .so file from an OCI registry.
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: plugin-oci
spec:
  description: Test Plugin with OCI artifact reference
  bindings:
    - name: falco_name
      value: falco-test
    - name: falco_version
      value: "0.43.0"
    - name: plugin_dir
      value: "/usr/share/falco/plugins"
    - name: min_size
      value: "1000"
  steps:
    - name: Create Falco instance
      use:
        template: ../common/_step_templates/apply-assert-falco-daemonset.yaml
    - name: Wait for Falco pod to be ready
      use:
        template: ../common/_step_templates/wait-falco-pod-ready.yaml

    - name: Create Plugin from OCI registry
      try:
        - apply:
            file: plugin.yaml

    - name: Verify plugin file downloaded
      use:
        template: ../common/_step_templates/verify-plugin.yaml
