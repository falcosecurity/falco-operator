name: E2E Tests

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test-e2e:
    name: Tests E2E
    runs-on: ubuntu-latest
    steps:
      - name: Clone the code
        uses: actions/checkout@v6.0.2

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Install chainsaw
        uses: kyverno/action-install-chainsaw@v0.2.12

      - name: Install kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/latest/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Create kind cluster
        run: kind create cluster --wait 60s

      - name: Build artifact-operator image
        run: make docker-build OPERATOR=artifact IMG=falcosecurity/artifact-operator:e2e

      - name: Build falco-operator image
        run: make docker-build OPERATOR=falco IMG=falcosecurity/falco-operator:e2e ARTIFACT_OPERATOR_IMAGE=falcosecurity/artifact-operator:e2e

      - name: Load images into kind
        run: |
          kind load docker-image falcosecurity/artifact-operator:e2e
          kind load docker-image falcosecurity/falco-operator:e2e

      - name: Install CRDs
        run: make install

      - name: Deploy operator
        run: make deploy IMG=falcosecurity/falco-operator:e2e

      - name: Wait for operator
        run: kubectl wait --for=condition=Available deployment/falco-operator -n falco-operator --timeout=120s

      - name: Run e2e tests
        run: chainsaw test --config test/e2e/chainsaw/.chainsaw.yaml --test-dir test/e2e/chainsaw/

      - name: Collect operator logs
        if: failure()
        run: |
          echo "=== Falco Operator Logs ==="
          kubectl logs -n falco-operator deployment/falco-operator --tail=200 || true
          echo "=== Cluster Events ==="
          kubectl get events --all-namespaces --sort-by='.lastTimestamp' | tail -50 || true

      - name: Cleanup
        if: always()
        run: kind delete cluster || true
